using System.IO;
using System.Text;
using System;
using OfficeOpenXml;
using excel;
using selectsheet;
using similarcompare;
namespace duqu
{
    class help//用于存放静态变量
    {
        public static string helpword;//帮助文档
        public static bool allcyc_key;//判断总程序是否继续
        public static bool outputcyc_key;//判断输出程序是否继续
        public static int danciwhere;//记录当前指向单词位置
        public help()
        {  //获取help文档
            StreamReader r = new StreamReader(@"./data/help.txt", Encoding.UTF8);
            allcyc_key = true;
            danciwhere = 0;
            helpword = r.ReadToEnd();
            r.Close();
            //获取完毕
        }

    }
    class duqu//开始
    {
        static void Main()
        {
            help helpw = new help();//初始化静态变量
            sheet sheet_operator = new sheet();
            string url = sheet_operator.operate();

            FileInfo newFile1 = new FileInfo(url);
            ExcelPackage.LicenseContext = LicenseContext.NonCommercial;//nuple需要的东西
            ExcelPackage package = new ExcelPackage(newFile1);//创建包
            ExcelWorkbook workbook = (ExcelWorkbook)package.Workbook;
            ExcelWorksheet worksheet0 = (ExcelWorksheet)workbook.Worksheets[0];
            ExcelWorksheet worksheet1 = (ExcelWorksheet)workbook.Worksheets[1];
            method m1 = new method(worksheet0, worksheet1);
            Console.WriteLine(help.helpword);
            while (help.allcyc_key)//建立循环
            {
                Console.WriteLine("这里是开头\n");
                Console.WriteLine("此表有{0}个单词", worksheet1.Cells[1, 1].Value);
                string mode = Console.ReadLine();
                switch (mode)
                {
                    case "d":
                        {
                            try
                            {
                                m1.outputword();
                            }
                            catch
                            {
                                Console.WriteLine("发生错误，请重新输入，注意检查");
                            }
                            break;
                        }
                    case "s":
                        {
                            try
                            {
                                Console.WriteLine("几个？");
                                int[] number = new int[int.Parse(Console.ReadLine())];//获取要输出的单词个数
                                string s = worksheet1.Cells[1, 1].ToText();//获取单词总个数
                                m1.creatrandom(ref number, int.Parse(s.Substring(0, s.Length - 1)));//创建随机单词的序号
                                m1.randomword(number);//输出随机单词
                            }
                            catch
                            {
                                Console.WriteLine("发生错误，请重新输入，注意检查");
                            }
                            break;
                        }
                    case "help":
                        {
                            Console.WriteLine(help.helpword);
                        }
                        break;
                    case "t":
                        help.allcyc_key = false;
                        break;
                    case "find":
                        m1.changword.findwordmean();
                        break;
                    case "addword":
                        m1.changword.addword();
                        break;
                }
            }
            package.Save();
        }
    }
    class method//查看单词，对输入进行反应
    {
        public mean changword;
        ExcelWorksheet worksheet0, worksheet1;
        public method(ExcelWorksheet worksheet0, ExcelWorksheet worksheet1)
        {
            this.worksheet0 = worksheet0;
            this.worksheet1 = worksheet1;
            changword = new mean(worksheet0, worksheet1);
        }
        public void outputword()//输出固定单词表
        {
            help.outputcyc_key = true;
            Console.WriteLine("从第几个开始？");
            help.danciwhere = int.Parse(Console.ReadLine());//第几个单词开始
            while (worksheet0.Cells[help.danciwhere, 1].Value != null && help.outputcyc_key)
            {
                Console.WriteLine(worksheet0.Cells[help.danciwhere, 1].Value + " " + help.danciwhere + " 难度" + worksheet0.Cells[help.danciwhere, 3].Value);//标记当前位置并输出
                checkinput();
                if (help.outputcyc_key)
                {
                    Console.WriteLine(worksheet0.Cells[help.danciwhere, 2].Value + " " + help.danciwhere);
                    checkinput();
                    help.danciwhere++;
                }
            }
            if (help.outputcyc_key)
            {
                help.danciwhere = 0;
                Console.WriteLine("没有这么多单词了");
            }
        }
        public void randomword(int[] shunxu)//输出随机单词
        {
            help.outputcyc_key = true;
            int biaohao = 0;// 记录数组下标
            while (help.outputcyc_key && biaohao < shunxu.Length)
            {
                help.danciwhere = shunxu[biaohao];//提取下一个单词序号
                Console.WriteLine(worksheet0.Cells[help.danciwhere, 1].Value + " " + (biaohao + 1) + " 难度" + worksheet0.Cells[help.danciwhere, 3].Value);//标记当前位置并输出
                checkinput();
                if (help.outputcyc_key)
                {
                    Console.WriteLine(worksheet0.Cells[help.danciwhere, 2].Value + " " + (biaohao + 1));
                    checkinput();
                }
                biaohao++;
            }
            if (help.outputcyc_key)
            {
                help.danciwhere = 0;
                Console.WriteLine("没有这么多单词了");
            }
        }
        public void creatrandom(ref int[] a, int number)//创建读取的单词序号
        {
            int leng = a.Length;
            Random r = new Random();
            a[0] = (int)r.Next(1, number);
            for (int i = 1; i < leng; i++)
            {
                int tool = (int)r.Next(1, number);
                bool flag = false;
                foreach (int k in a)//去重
                {
                    if (tool == k) { flag = true; break; }
                }
                if (flag) i--;
                else a[i] = tool;
            }

        }
        void checkinput()//检测单词输出部分用户的操作
        {
            string s = Console.ReadLine();
            switch (s)
            {
                case "t": //退出程序
                    help.allcyc_key = false;
                    help.outputcyc_key = false;
                    break;
                case "z": //跳转至开头
                    help.outputcyc_key = false;
                    Console.Clear();
                    break;
                case "help"://查看help文档
                    {
                        Console.WriteLine(help.helpword);
                        checkinput();
                        break;
                    }
                case "addword"://增加单词
                    {
                        changword.addword();
                        checkinput();
                    }
                    break;
                case "problem"://增加难度值
                    {
                        string tool1 = worksheet0.Cells[help.danciwhere, 3].ToText();
                        int tool2 = int.Parse(tool1.Substring(0, tool1.Length - 1));
                        tool2++;
                        worksheet0.Cells[help.danciwhere, 3].Value = tool2.ToString();
                    }
                    break;
                case "solve"://降低难度值
                    {

                        string tool1 = worksheet0.Cells[help.danciwhere, 3].ToText();
                        int tool2 = int.Parse(tool1.Substring(0, tool1.Length - 1));
                        tool2--;
                        if (tool2 < 0) { tool2 = 0; }
                        worksheet0.Cells[help.danciwhere, 3].Value = tool2.ToString();
                    }
                    break;
                case "addmean"://补充单词意思
                    {
                        changword.addmean(help.danciwhere);
                        checkinput();
                    }
                    break;
                case "changemean"://改变单词意思
                    {
                        changword.changmean(help.danciwhere);
                        checkinput();
                    }
                    break;
                case "find": //查找单词意思
                    {
                        changword.findwordmean();
                        checkinput();
                    }
                    break;
                default: break;
            }
        }//检查输入字符并进行操作
    }
    class mean//对单词进行操作
    {
        private ExcelWorksheet worksheet0;
        private ExcelWorksheet worksheet1;
        private int dancinumber;//单词总数
        public mean(ExcelWorksheet worksheet0, ExcelWorksheet worksheet1)
        {
            this.worksheet0 = worksheet0;
            this.worksheet1 = worksheet1;
            string number = worksheet1.Cells[1, 1].ToText();
            this.dancinumber = int.Parse(number.Substring(0, number.Length - 1));
        }
        public void addword()
        {
            string s;
            Console.WriteLine("开始录入，输入e退出");
            while (true)
            {
                Console.WriteLine("单词");
                s = Console.ReadLine();
                if (s == "e") break;
                else
                {
                    worksheet0.Cells[dancinumber + 1, 1].Value = s;
                    worksheet0.Cells[dancinumber + 1, 3].Value = 5;
                }

                Console.WriteLine("意思");
                s = Console.ReadLine();
                if (s == "e")
                {
                    Console.WriteLine("这次输入的单词无效");
                    break;
                }
                else
                {
                    worksheet0.Cells[dancinumber + 1, 2].Value = s;
                    dancinumber++;
                }
            }
            Console.WriteLine("添加完毕,在程序正常关闭后生效（不要按右上，按t）");
            worksheet1.Cells[1, 1].Value = dancinumber;
        }
        public void addmean(int danciwhere)
        {
            Console.WriteLine("输入单词意思");
            string wordmean = Console.ReadLine();
            Console.WriteLine("你输入的单词意思为\t" + wordmean + "\n yes or no?");
            string save = Console.ReadLine();
            switch (save)
            {
                case "yes":
                    worksheet0.Cells[danciwhere, 2].Value = worksheet0.Cells[danciwhere, 2].ToText() + wordmean;
                    Console.WriteLine("添加完毕,在程序正常关闭后生效（不要按右上，按t）");
                    break;
                case "no":
                    Console.WriteLine("停止添加");
                    break;
                default:
                    Console.WriteLine("未确认，停止添加");
                    break;
            }
        }
        public void changmean(int danciwhere)
        {
            Console.WriteLine("输入单词意思");
            string wordmean = Console.ReadLine();
            Console.WriteLine("你输入的单词意思为\t" + wordmean + "\n" + "单词意思会被完全取代，yes or no？");
            string save = Console.ReadLine();
            switch (save)
            {
                case "yes":
                    worksheet0.Cells[danciwhere, 2].Value = wordmean;
                    Console.WriteLine("添加完毕,在程序正常关闭后生效（不要按右上，按t）");
                    break;
                case "no":
                    Console.WriteLine("停止添加");
                    break;
                default:
                    Console.WriteLine("未确认，停止添加");
                    break;
            }

        }
         public void changword(int danciwhere)
        {
            Console.WriteLine("输入单词");
            string wordmean = Console.ReadLine();
            Console.WriteLine("你输入的单词为\t" + wordmean + "\n" + "单词会被完全取代，yes or no？");
            string save = Console.ReadLine();
            switch (save)
            {
                case "yes":
                    worksheet0.Cells[danciwhere, 1].Value = wordmean;
                    Console.WriteLine("添加完毕,在程序正常关闭后生效（不要按右上，按t）");
                    break;
                case "no":
                    Console.WriteLine("停止添加");
                    break;
                default:
                    Console.WriteLine("未确认，停止添加");
                    break;
            }

        }
        public void findwordmean()//查找单词
        {
            wordfind w = new wordfind(worksheet0, dancinumber);//创建查找对象
            Console.WriteLine("输入单词");
            string input = Console.ReadLine();//获取输入单词
            bool findornot = true;//判断是否匹配
            foreach (string[] g in w)
            {
                if (g[0].Equals(input))//判断单词是否符合
                {
                    Console.WriteLine(g[1]);//输出单词意思
                    findornot = false;
                    break;
                }
            }
            if (findornot)
            {
                Console.WriteLine("没有找到这个单词,以下为相似单词结果");
                fuzzyfind(input, w);//调用模糊查找
            }
        }
        private void fuzzyfind(string word, wordfind w)//模糊查找
        {
            
            // double similarlv = 0;
           double similarlv=0;
            foreach (string[] s in w)
            {   
                similarlv=similarcompare.operate.StringCompare(word,s[0]);
                double Length = s[0].Length;
                if(similarlv<=3 && similarlv/Length<=0.25)
                {
                    Console.WriteLine(s[0] + "\n" + s[1] + "\n");
                }
                // similarlv = new SimilarityTool().CompareStrings(word, s[0]);
                // if (similarlv >= 0.7)
                // {
                //     Console.WriteLine(s[0] + "\n" + s[1] + "\n");
                // }
            }
        }
    }

}
